/*
 * kalman_fns.c
 *
 *  Created on: Sep 9, 2024
 *      Author: dannato Francesco Stasi
 */
#include <math.h>
#include "filter.h"

Orientation or;
float old_roll;

void updateOrientation(float accX, float accY, float accZ, float gyroX, float gyroY, float gyroZ) 
{

  // compute pitch and roll from acc
  float pitchAcc = atan(accX /  sqrt(accY^2 + accZ^2));
  float rollAcc = atan(-accY / sqrt(accX^2 + accZ^2));
  float yawAcc = atan2(accY, accX);

  float pitchGyro = gyroX * DT;
  float rollGyro = gyroY * DT;
  float yawGyro = gyroZ * DT;

  // include complementary filter
  or.pitch = ALPHA * (or.pitch + pitchGyro) + (1 - ALPHA) * pitchAcc;
  or.roll = ALPHA * (or.roll + rollGyro) + (1 - ALPHA) * rollAcc;

  or.yaw += gyroZ * DT;
  if (or.yaw < 0) or.yaw += 360;
  else if (or.yaw > 359) or.yaw -= 360;

}

float getPitch() {
  return or.pitch;
}
float getRoll() {
  return or.roll;
}

float getYaw() {
  return or.yaw;
}
